<div class="div-container mat-elevation-z4">
    <div class="borde">
        <h1>{{ isReadOnly ? 'Detalles de la Compra' : 'Registrar Nueva Compra' }}</h1>
    </div>
    <form [formGroup]="form" (ngSubmit)="onSubmit()" #detalleForm="ngForm" class="form-container">
        <div class="form-gred">
            <h3>Información de la compra</h3>
            <div class="form-grid">
                <!-- Campos compra -->
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Registrado por</mat-label>
                    <mat-select formControlName="user_identifier">
                        <mat-option *ngFor="let user of users" [value]="user.identifier">
                            {{ user.name }}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="form.get('user_identifier')?.hasError('required')">
                        El Encargado es obligatorio
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Proveedor</mat-label>
                    <mat-select formControlName="supplier_identifier">
                        <mat-option *ngFor="let supplier of suppliers" [value]="supplier.identifier">
                            {{ supplier.company }}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="form.get('supplier_identifier')?.hasError('required')">
                        El proveedor es obligatorio
                    </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Método de pago</mat-label>
                    <mat-select formControlName="payment_method">
                        <mat-option value="Efectivo">Efectivo</mat-option>
                        <mat-option value="Yape">Yape</mat-option>
                        <mat-option value="Transferencia">Transferencia</mat-option>
                    </mat-select>
                    <mat-error *ngIf="form.get('payment_method')?.hasError('required')">
                        El método de pago es obligatorio
                    </mat-error>
                    <mat-error *ngIf="form.get('payment_method')?.hasError('pattern')">
                        Solo se permiten letras sin caracteres especiales ni números
                    </mat-error>
                </mat-form-field>
            </div>

            <div class="borde"></div>

            <h3>Productos comprados</h3>
            <div *ngIf="!isReadOnly" class="form-grid">
                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Producto</mat-label>
                    <mat-select [(ngModel)]="detalle.product_identifier" name="product_identifier"
                        [ngModelOptions]="{ standalone: true }" required #prod="ngModel">
                        <mat-option *ngFor="let product of products" [value]="product.identifier">
                            {{ product.name }}
                        </mat-option>
                    </mat-select>
                    <mat-error *ngIf="prod.errors?.['required']">El producto es obligatorio</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Cantidad</mat-label>
                    <input matInput [(ngModel)]="detalle.amount" name="amount" [ngModelOptions]="{ standalone: true }"
                        (ngModelChange)="calcularSubtotal()" (keypress)="onlyNumbers($event)" min="1" required
                        #amt="ngModel">
                    <mat-error *ngIf="amt.errors?.['required']">La cantidad es obligatoria</mat-error>
                    <mat-error *ngIf="amt.errors?.['min']">La cantidad debe ser mayor a 0</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Costo Unitario</mat-label>
                    <input matInput [(ngModel)]="detalle.unitCost" name="unitCost"
                        [ngModelOptions]="{ standalone: true }" (ngModelChange)="calcularSubtotal()"
                        (keypress)="onlyDecimal($event)" min="0.01" required #cost="ngModel">
                    <mat-error *ngIf="cost.errors?.['required']">El costo unitario es obligatorio</mat-error>
                    <mat-error *ngIf="cost.errors?.['min']">El costo debe ser mayor a 0</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Subtotal</mat-label>
                    <input matInput [value]="detalle.subtotal | number:'1.2-2'" readonly>
                </mat-form-field>

                <button mat-raised-button color="primary" type="button" (click)="agregarDetalle()">
                    Agregar Detalle
                </button>
            </div>

            <!-- Tabla de detalles agregados -->
            <table mat-table [dataSource]="detalles" class="mat-elevation-z8 full-width" *ngIf="detalles.length > 0">
                <!-- Producto -->
                <ng-container matColumnDef="producto">
                    <th mat-header-cell *matHeaderCellDef>Producto</th>
                    <td mat-cell *matCellDef="let d"> {{ getNombreProducto(d.product_identifier) }} </td>
                </ng-container>

                <!-- Cantidad -->
                <ng-container matColumnDef="cantidad">
                    <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                    <td mat-cell *matCellDef="let d"> {{ d.amount }} </td>
                </ng-container>

                <!-- Costo Unitario -->
                <ng-container matColumnDef="costo">
                    <th mat-header-cell *matHeaderCellDef>Costo Unitario</th>
                    <td mat-cell *matCellDef="let d"> S/ {{ d.unitCost | number:'1.2-2' }} </td>
                </ng-container>

                <!-- Subtotal -->
                <ng-container matColumnDef="subtotal">
                    <th mat-header-cell *matHeaderCellDef>Subtotal</th>
                    <td mat-cell *matCellDef="let d"> S/ {{ d.subtotal | number:'1.2-2' }} </td>
                </ng-container>

                <!-- Acción -->
                <ng-container matColumnDef="accion">
                    <th mat-header-cell *matHeaderCellDef>Acción</th>
                    <td mat-cell *matCellDef="let d; let i = index;">
                        <button mat-icon-button color="warn" type="button" (click)="eliminarDetalle(i)"
                            *ngIf="!isReadOnly">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedDetailColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedDetailColumns;"></tr>
            </table>

            <!-- Total -->
            <div class="total-general" *ngIf="detalles.length > 0" style="margin-top: 1rem;">
                <strong>Total de la Compra: </strong> S/ {{ calcularTotalCompra() | number:'1.2-2' }}
            </div>
        </div>

        <!-- Botones acción -->
        <div class="form-actions">
            <button mat-raised-button color="warn" type="button" (click)="onCancel()">
                {{ isReadOnly ? 'Volver' : 'Cancelar' }}
            </button>
            <button *ngIf="!isReadOnly" mat-raised-button color="primary" type="submit"
                [disabled]="form.invalid || detalles.length === 0">
                Registrar
            </button>
        </div>
    </form>
    <app-alert [message]="alertMessage" [type]="alertType" [visible]="showAlert" [confirm]="confirmAlert"
        (close)="showAlert = false" (confirmResult)="handleAlertConfirm($event)">
    </app-alert>
</div>